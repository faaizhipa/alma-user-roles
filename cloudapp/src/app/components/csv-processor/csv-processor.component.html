<div class="csv-processor">
  <!-- File Upload Section -->
  <mat-card class="upload-card" *ngIf="!csvData">
    <mat-card-header>
      <mat-card-title>{{ 'CSV.Upload.Title' | translate }}</mat-card-title>
      <mat-card-subtitle>{{ 'CSV.Upload.Subtitle' | translate }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="upload-area"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onFileDrop($event)"
           [class.drag-active]="isDragActive">

        <input type="file"
               accept=".csv"
               (change)="onFileSelected($event)"
               #fileInput
               style="display: none">

        <div class="upload-content">
          <mat-icon class="upload-icon">cloud_upload</mat-icon>
          <p class="upload-text">{{ 'CSV.Upload.DragDrop' | translate }}</p>
          <p class="upload-subtext">{{ 'CSV.Upload.OrClick' | translate }}</p>
          <button mat-raised-button
                  color="primary"
                  (click)="fileInput.click()">
            <mat-icon>upload_file</mat-icon>
            {{ 'CSV.Upload.SelectFile' | translate }}
          </button>
        </div>
      </div>

      <!-- File Requirements -->
      <div class="file-requirements">
        <h4>{{ 'CSV.Requirements.Title' | translate }}</h4>
        <ul>
          <li>{{ 'CSV.Requirements.Format' | translate }}</li>
          <li>{{ 'CSV.Requirements.Headers' | translate }}</li>
          <li>{{ 'CSV.Requirements.Encoding' | translate }}</li>
        </ul>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Column Mapping Section -->
  <mat-card *ngIf="csvData && showColumnMapping" class="mapping-card">
    <mat-card-header>
      <mat-card-title>{{ 'CSV.Mapping.Title' | translate }}</mat-card-title>
      <mat-card-subtitle>{{ 'CSV.Mapping.Subtitle' | translate }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <!-- Preview of uploaded data -->
      <div class="data-preview">
        <h4>{{ 'CSV.Preview.Title' | translate }}</h4>
        <p>{{ 'CSV.Preview.Records' | translate : {count: csvData.data.length} }}</p>
      </div>

      <!-- Column mapping table -->
      <div class="mapping-container">
        <table mat-table [dataSource]="columnMappingData" class="mapping-table">

          <!-- CSV Header Column -->
          <ng-container matColumnDef="csvHeader">
            <th mat-header-cell *matHeaderCellDef>{{ 'CSV.Mapping.CSVHeader' | translate }}</th>
            <td mat-cell *matCellDef="let element">
              <code class="csv-header">{{element.csvHeader}}</code>
            </td>
          </ng-container>

          <!-- Sample Value Column -->
          <ng-container matColumnDef="sampleValue">
            <th mat-header-cell *matHeaderCellDef>{{ 'CSV.Mapping.SampleValue' | translate }}</th>
            <td mat-cell *matCellDef="let element">
              <span class="sample-value" [title]="element.sampleValue">
                {{element.sampleValue | slice:0:40}}
                <span *ngIf="element.sampleValue?.length > 40">...</span>
              </span>
            </td>
          </ng-container>

          <!-- Field Mapping Column -->
          <ng-container matColumnDef="mappedField">
            <th mat-header-cell *matHeaderCellDef>{{ 'CSV.Mapping.MapToField' | translate }}</th>
            <td mat-cell *matCellDef="let element">
              <mat-select [(value)]="element.mappedField"
                          (selectionChange)="validateMapping()"
                          [placeholder]="'CSV.Mapping.SelectField' | translate">
                <mat-option value="mmsId">
                  <strong>MMS ID</strong> - {{ 'Fields.MmsId.Description' | translate }}
                </mat-option>
                <mat-option value="remoteUrl">
                  <strong>Remote URL</strong> - {{ 'Fields.RemoteUrl.Description' | translate }}
                </mat-option>
                <mat-option value="fileTitle">
                  <strong>File Title</strong> - {{ 'Fields.FileTitle.Description' | translate }}
                </mat-option>
                <mat-option value="fileDescription">
                  <strong>File Description</strong> - {{ 'Fields.FileDescription.Description' | translate }}
                </mat-option>
                <mat-option value="fileType">
                  <strong>File Type</strong> - {{ 'Fields.FileType.Description' | translate }}
                </mat-option>
                <mat-option value="ignore" class="ignore-option">
                  {{ 'CSV.Mapping.IgnoreColumn' | translate }}
                </mat-option>
              </mat-select>

              <!-- Confidence indicator -->
              <div class="confidence-indicator" *ngIf="element.confidence > 0.7">
                <mat-icon class="confidence-high" [title]="'CSV.Mapping.HighConfidence' | translate">
                  check_circle
                </mat-icon>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>

      <!-- Validation Messages -->
      <div class="validation-messages" *ngIf="validationErrors.length > 0 || validationWarnings.length > 0">
        <div class="errors" *ngIf="validationErrors.length > 0">
          <mat-error *ngFor="let error of validationErrors">
            <mat-icon>error</mat-icon>
            {{ error }}
          </mat-error>
        </div>
        <div class="warnings" *ngIf="validationWarnings.length > 0">
          <div class="warning" *ngFor="let warning of validationWarnings">
            <mat-icon>warning</mat-icon>
            {{ warning }}
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="mapping-actions">
        <button mat-raised-button
                color="primary"
                [disabled]="!isValidMapping()"
                (click)="processMappedData()">
          <mat-icon>play_arrow</mat-icon>
          {{ 'CSV.Actions.ProcessData' | translate }}
        </button>
        <button mat-button (click)="resetUpload()">
          <mat-icon>refresh</mat-icon>
          {{ 'CSV.Actions.UploadDifferent' | translate }}
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Processing Progress -->
  <mat-card *ngIf="isProcessing" class="processing-card">
    <mat-card-content>
      <div class="processing-status">
        <mat-progress-bar mode="determinate" [value]="processingProgress"></mat-progress-bar>
        <p>{{ 'CSV.Processing.Status' | translate : {current: processedCount, total: totalCount} }}</p>
        <div class="processing-details" *ngIf="currentProcessingItem">
          <small>{{ 'CSV.Processing.Current' | translate }}: {{ currentProcessingItem }}</small>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
