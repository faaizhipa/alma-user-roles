<div class="csv-processor">
  <!-- Step 1: File Upload -->
  <mat-card *ngIf="currentStep === 0">
    <mat-card-header>
      <mat-card-title>{{ 'csvProcessor.upload.title' | translate }}</mat-card-title>
      <mat-card-subtitle>{{ 'csvProcessor.upload.subtitle' | translate }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <!-- File Requirements -->
      <div class="requirements-section">
        <h3>{{ 'csvProcessor.requirements.title' | translate }}</h3>
        <ul>
          <li>{{ 'csvProcessor.requirements.format' | translate }}</li>
          <li>{{ 'csvProcessor.requirements.headers' | translate }}</li>
          <li>{{ 'csvProcessor.requirements.encoding' | translate }}</li>
        </ul>
      </div>

      <!-- Drop Zone -->
      <div
        class="drop-zone"
        (drop)="onFileDrop($event)"
        (dragover)="onDragOver($event)"
      >
        <mat-icon class="upload-icon">cloud_upload</mat-icon>
        <p>{{ 'csvProcessor.upload.dropzone' | translate }}</p>
        <p class="or-text">{{ 'csvProcessor.upload.or' | translate }}</p>
        <input
          type="file"
          accept=".csv"
          (change)="onFileSelected($event)"
          #fileInput
          style="display: none"
        />
        <button mat-raised-button color="primary" (click)="fileInput.click()">
          <mat-icon>attach_file</mat-icon>
          {{ 'csvProcessor.upload.selectFile' | translate }}
        </button>
      </div>

      <!-- Validation Errors -->
      <div *ngIf="validationErrors.length > 0" class="validation-errors">
        <mat-error *ngFor="let error of validationErrors">{{ error }}</mat-error>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Step 2: Column Mapping -->
  <mat-card *ngIf="currentStep === 1">
    <mat-card-header>
      <mat-card-title>{{ 'csvProcessor.mapping.title' | translate }}</mat-card-title>
      <mat-card-subtitle>{{ 'csvProcessor.mapping.subtitle' | translate }}</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="mapping-table-container">
        <table mat-table [dataSource]="columnMappings" class="mapping-table">
          <!-- CSV Header Column -->
          <ng-container matColumnDef="csvHeader">
            <th mat-header-cell *matHeaderCellDef>{{ 'csvProcessor.mapping.csvHeader' | translate }}</th>
            <td mat-cell *matCellDef="let mapping">{{ mapping.csvHeader }}</td>
          </ng-container>

          <!-- Sample Value Column -->
          <ng-container matColumnDef="sampleValue">
            <th mat-header-cell *matHeaderCellDef>{{ 'csvProcessor.mapping.sampleValue' | translate }}</th>
            <td mat-cell *matCellDef="let mapping" class="sample-value">
              {{ mapping.sampleValue }}
            </td>
          </ng-container>

          <!-- Map To Field Column -->
          <ng-container matColumnDef="mapToField">
            <th mat-header-cell *matHeaderCellDef>{{ 'csvProcessor.mapping.mapToField' | translate }}</th>
            <td mat-cell *matCellDef="let mapping">
              <mat-form-field appearance="fill">
                <mat-label>{{ 'csvProcessor.mapping.selectField' | translate }}</mat-label>
                <mat-select
                  [value]="mapping.mappedField"
                  (selectionChange)="updateMapping(mapping, $event.value)"
                >
                  <mat-option *ngFor="let field of fieldTypes" [value]="field.value">
                    {{ field.label }}
                    <span *ngIf="field.required" class="required-indicator">*</span>
                  </mat-option>
                </mat-select>
              </mat-form-field>
              <span
                *ngIf="mapping.confidence >= 0.8 && mapping.mappedField !== 'ignore'"
                class="confidence-badge"
                [matTooltip]="'csvProcessor.mapping.highConfidence' | translate"
              >
                <mat-icon>check_circle</mat-icon>
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['csvHeader', 'sampleValue', 'mapToField']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['csvHeader', 'sampleValue', 'mapToField']"></tr>
        </table>
      </div>

      <!-- Validation Errors -->
      <div *ngIf="validationErrors.length > 0" class="validation-errors">
        <mat-error *ngFor="let error of validationErrors">{{ error }}</mat-error>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <button mat-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        {{ 'csvProcessor.actions.back' | translate }}
      </button>
      <button mat-raised-button color="primary" (click)="validateAndProceed()">
        {{ 'csvProcessor.actions.next' | translate }}
        <mat-icon>arrow_forward</mat-icon>
      </button>
    </mat-card-actions>
  </mat-card>

  <!-- Step 3: Preview & Process -->
  <mat-card *ngIf="currentStep === 2">
    <mat-card-header>
      <mat-card-title>{{ 'csvProcessor.preview.title' | translate }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p>{{ 'csvProcessor.preview.records' | translate: { count: csvData?.data.length } }}</p>

      <!-- Processing Progress -->
      <div *ngIf="isProcessing" class="processing-section">
        <p>
          {{ 'csvProcessor.processing.status' | translate: {
            current: processingProgress?.current,
            total: processingProgress?.total
          } }}
        </p>
        <mat-progress-bar
          mode="determinate"
          [value]="processingProgress?.percentage || 0"
        ></mat-progress-bar>
        <p class="current-asset">
          {{ 'csvProcessor.processing.current' | translate }}: {{ processingProgress?.currentAsset }}
        </p>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <button mat-button (click)="goBack()" [disabled]="isProcessing">
        <mat-icon>arrow_back</mat-icon>
        {{ 'csvProcessor.actions.back' | translate }}
      </button>
      <button mat-button (click)="uploadDifferent()" [disabled]="isProcessing">
        {{ 'csvProcessor.actions.uploadDifferent' | translate }}
      </button>
      <button
        mat-raised-button
        color="primary"
        (click)="processData()"
        [disabled]="isProcessing"
      >
        <mat-icon>play_arrow</mat-icon>
        {{ 'csvProcessor.actions.processData' | translate }}
      </button>
    </mat-card-actions>
  </mat-card>
</div>
